"use strict"

// TODO: add `diff` support
// var diff = require("diff")
var Console = require("./console.js")
var hasOwn = Object.prototype.hasOwnProperty

/**
 * Since it's so easy to accidentially not instantiate the stock reporter. It's
 * best to verify, and complain when it gets called, so it doesn't silently
 * fail to work (the stock reporters *do* accept option objects, and a report
 * would otherwise be a valid argument). This will likely get called twice when
 * mistakenly not instantiated beforehand, once with a `"start"` event and once
 * with an `"error"` event, so an error will eventually propagate out of the
 * chain.
 */
exports.isReport = function (opts) {
    if (!hasOwn.call(opts, "type")) return false
    if (!hasOwn.call(opts, "value")) return false
    if (!hasOwn.call(opts, "path")) return false

    return typeof opts.type === "string" && Array.isArray(opts.path)
}

exports.joinPath = function (ev) {
    var path = ""

    for (var i = 0; i < ev.path.length; i++) {
        path += " " + ev.path[i].name
    }

    return path.slice(1)
}

exports.speed = function (ev) {
    if (ev.duration >= ev.slow) return "slow"
    if (ev.duration >= ev.slow / 2) return "medium"
    if (ev.duration >= 0) return "fast"
    throw new RangeError("Duration must not be negative")
}

exports.formatTime = (function () {
    var s = 1000 /* ms */
    var m = 60 * s
    var h = 60 * m
    var d = 24 * h

    return function (ms) {
        if (ms >= d) return Math.round(ms / d) + "d"
        if (ms >= h) return Math.round(ms / h) + "h"
        if (ms >= m) return Math.round(ms / m) + "m"
        if (ms >= s) return Math.round(ms / s) + "s"
        return ms + "ms"
    }
})()

exports.defaultify = function (r, prop, promisify) {
    if (r.methods.accepts.indexOf(prop) >= 0) {
        var used

        if (typeof r.opts[prop] === "function") {
            used = r.opts
        } else {
            used = Console.defaultOpts
        }

        r.opts[prop] = promisify(used[prop], used)
    }
}

// exports.unifiedDiff = function (err) {
//     var msg = diff.createPatch("string", err.actual, err.expected)
//     var lines = msg.split("\n").slice(0, 4)
//     var ret = "\n      " +
//         color("diff added", "+ expected") + " " +
//         color("diff removed", "- actual") +
//         "\n"
//
//     for (var i = 0; i < lines.length; i++) {
//         var line = lines[i]
//
//         if (line[0] === "+") {
//             ret += "\n      " + color("diff added", line)
//         } else if (line[0] === "-") {
//             ret += "\n      " + color("diff removed", line)
//         } else if (!/\@\@|\\ No newline/.test(line)) {
//             ret += "\n      " + line
//         }
//     }
//
//     return ret
// }
